#!/usr/bin/env python3

from datetime import datetime
from pathlib import Path
import re


def slugify(title):
    title = title.encode('ascii', 'ignore').decode('ascii').strip().lower()
    title = re.sub(r'[\W_]', '-', title)
    title = re.sub(r'-+', '-', title)
    return title


def main():
    # the binary is in blog/bin/new_post, if you go up twice, then
    # enter the directory 'posts', you end up in the right place
    posts_path = Path(__file__).resolve().parent.parent / Path('posts')
    while True:
        title = input("Enter a title: ")
        slug = slugify(title)
        slugs = [Path(p).stem for p in Path(posts_path).glob('*.rst')]
        if slug in slugs:
            print("Title is already taken.")
        else:
            break

    timestamp = datetime.now().strftime('%Y-%m-%d %H:%M:%S')
    content = [':title: {}'.format(title), ':date: {}'.format(timestamp),
               ':published: no', ':category: test', '', '']

    with (Path(posts_path) / Path(slug).with_suffix('.rst')).open('w') as p:
        p.write('\n'.join(content))


if __name__ == '__main__':
    main()
